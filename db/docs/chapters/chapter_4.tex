\chapter{Implementazione del Database}

In conclusione si riportano le istruzioni per la creazione del database e la sua popolazione.

Come DBMS provider si è scelto di utilizzare PostgreSQL, per la sua facilità di utilizzo e la sua affidabilità.

Il database è hostato localmente per rendere più agevole la connessione.

Per pulizia del codice si è preferito lavorare su uno \textbf{schema} creato appositamente per il progetto, chiamato \textbf{UninaDelivery}.

\section{Definizione dei Domini Personalizzati}

Vista la vasta gamma di vincoli di dominio simili su vari campi, si è deciso di definire dei domini personalizzati per facilitare la creazione delle tabelle.

\begin{lstlisting}
  CREATE DOMAIN letterString AS text CHECK (VALUE ~ '^[a-zA-Z]+$');
  
  CREATE DOMAIN numericString AS text CHECK (VALUE ~ '^[0-9]+$');
  
  CREATE DOMAIN alphanumericString AS text CHECK (VALUE ~ '^\w+$');
  
  CREATE DOMAIN emailString AS text CHECK (
    VALUE ~ '^\w+[\w.]*\w@[a-zA-Z.]+\.[a-zA-Z]{2,}$'
  );
\end{lstlisting}

Inoltre per i campi che nel diagramma ristrutturato sono stati definiti come \textbf{enumerazioni}, si è deciso di utilizzare dei tipi enumerati personalizzati.

\begin{lstlisting}
  CREATE TYPE WorldZone AS ENUM (
    'NA', 'EUW', 'EUNE', 'LATAM', 'MIDEAST', 'CKJ', 'SEA', 'IND', 'RUS', 'STAN', 
    'OC', 'AFN', 'AFC', 'AFS'
  );

  CREATE TYPE DepositType AS ENUM (
    'City', 'State', 'Country', 'Central'
  );

  CREATE TYPE TransportType AS ENUM (
    'WheeledSmall', 'WheeledLarge', 'Rails', 'Water', 'Air'
  );
  
  CREATE TYPE DrivingLicenceType AS ENUM ('BE', 'CE');
\end{lstlisting}

\section{Creazione delle Tabelle}

Vediamo ora la creazione delle tabelle, con annessi vincoli di dominio e di n-upla, oltre che le chiavi primarie e le chiavi esterne.

\begin{lstlisting}[caption={Creazione della tabella \textbf{Area}}]
  CREATE TABLE Area (
    ZipCode numericString NOT NULL,
    City letterString NOT NULL,
    State letterString NOT NULL,
    Country letterString NOT NULL,
    WorldZone WorldZone NOT NULL
  );
  ALTER TABLE Area ADD CONSTRAINT Area_pk PRIMARY KEY (ZipCode, Country);
\end{lstlisting}

\begin{lstlisting}[caption={Creazione della tabella \textbf{Account}}]
  CREATE TABLE Account (
    Name letterString NOT NULL,
    Surname letterString NOT NULL,
    Email emailString NOT NULL,
    Birthdate date NOT NULL,
    ProPic text,
    Password text NOT NULL,
    AddressNo alphNumString NOT NULL,
    Street alphNumString NOT NULL,
    ZipCode numericString NOT NULL,
    Country letterString NOT NULL
  );
  ALTER TABLE account ADD CONSTRAINT Account_pk PRIMARY KEY (Email);
  ALTER TABLE account ADD CONSTRAINT validAccountBirthdate CHECK (
    EXTRACT( YEAR FROM age(Birthdate)) >= 16 
  );
  ALTER TABLE account ADD CONSTRAINT formatAccountPassword CHECK(
    Password ~ '\b[A-Fa-f0-9]{64}\b'
  );
  ALTER TABLE account ADD CONSTRAINT formatAccountProPic CHECK (
    ProPic ~ '^\/9j\/4AAQSkZJRg[-A-Za-z0-9+\/]*={0,2}$'
  );
  ALTER TABLE Account ADD CONSTRAINT formatAccountAddressNo CHECK (
    AddressNo ~ '^[1-9]\d*[a-z]?(?:BIS)?$'
  );
  ALTER TABLE Account ADD CONSTRAINT account_fk FOREIGN KEY (ZipCode, Country) REFERENCES Area(ZipCode, Country);
\end{lstlisting}
   
\begin{lstlisting}
  CREATE TABLE "Order"(
    OrderID SERIAL, 
    EmissionDate Date NOT NULL,
    IsExpress boolean,
    ExtraWarranty smallint NOT NULL,
    IsCompleted boolean,
    Email emailString
  );
  ALTER TABLE "Order" ADD CONSTRAINT Order_pk PRIMARY KEY (OrderID);
  ALTER TABLE "Order" ADD CONSTRAINT formatOrderExtraWarranty CHECK (
    ExtraWarranty >=0
  );
  ALTER TABLE "Order" ADD CONSTRAINT Order_fk FOREIGN KEY (Email) REFERENCES Account(Email);
  ALTER TABLE "Order" ADD CONSTRAINT formatOrderEmissionDate CHECK (
    EmissionDate <= current_date
  );
\end{lstlisting}

\begin{lstlisting}
  CREATE TABLE Product (
    Category letterString NOT NULL,
    Name text NOT NULL,
    Supplier alphNumString NOT NULL,
    Description text NOT NULL,
    PackageSizeLiters real NOT NULL,
    IsFragile boolean,
    Price numeric(100,2)
  );
  ALTER TABLE Product ADD CONSTRAINT Product_pk PRIMARY KEY (Name,Supplier);
  ALTER TABLE Product ADD CONSTRAINT formatProductName CHECK(
    Name ~ '^[a-zA-Z0-9]+[\ a-zA-Z0-9!@#$%^&*()_+{}\[\]:;<>,.?~\\\/-]*$'
  );
  ALTER TABLE Product ADD CONSTRAINT formatProductDescription CHECK(
    Description ~ '^[a-zA-Z0-9]+[\ a-zA-Z0-9!@#$%^&*()_+{}\[\]:;<>,.?~\\\/-]*$'
  );
  ALTER TABLE Product ADD CONSTRAINT formatProductPackageSizeLiters CHECK(
    PackageSizeLiters > 0
  );
  ALTER TABLE Product ADD CONSTRAINT formatProductPrice CHECK(
    Price > 0
  );
  ALTER TABLE Product ADD CONSTRAINT checkProductDescriptionOnTopic CHECK(
    (Description ILIKE ('% ' || Category || ' %')) AND (Description ILIKE ('% ' || Name || ' %')) AND (Description ILIKE ('% ' || Supplier || ' %'))
  );
\end{lstlisting}

\begin{lstlisting}
  CREATE TABLE Contains (
    OrderID integer NOT NULL,
    Name text NOT NULL,
    Supplier alphNumString NOT NULL,
    IsSent boolean,
    Quantity smallint NOT NULL
  );
  ALTER TABLE contains ADD CONSTRAINT noDuplicateProductPerOrder UNIQUE(OrderID, Name, Supplier);
  ALTER TABLE contains ADD CONSTRAINT formatContainsQuantity CHECK (Quantity > 0);
  ALTER TABLE contains ADD CONSTRAINT contains_fk_order FOREIGN KEY (OrderID) REFERENCES "Order"(OrderID);
  ALTER TABLE contains ADD CONSTRAINT contains_fk_product FOREIGN KEY (Name,Supplier) REFERENCES Product(Name, Supplier);
\end{lstlisting}

\begin{lstlisting}
  CREATE TABLE Deposit (
    DepositID SERIAL NOT NULL,
    OccupiedSpace real NOT NULL,
    MaxCapacity real NOT NULL,
    DepositType DepositType,
    AddressNo alphNumString NOT NULL,
    Street alphNumString NOT NULL,
    ZipCode numericString NOT NULL,
    Country letterString NOT NULL
  );
  ALTER TABLE Deposit ADD CONSTRAINT Deposit_pk PRIMARY KEY ( DepositID);
  ALTER TABLE Deposit ADD CONSTRAINT foramtDepositOccupiedSpace CHECK(
    OccupiedSpace >= 0
  );
  ALTER TABLE Deposit ADD CONSTRAINT foramtDepositMaxCapacity CHECK(
    MaxCapacity > 0
  );
  ALTER TABLE Deposit ADD CONSTRAINT checkDepositFullness CHECK (
    OccupiedSpace <= MaxCapacity
  );
  ALTER TABLE Deposit ADD CONSTRAINT formatDepositAddressNo CHECK (
    AddressNo ~ '^[1-9]\d*[a-z]?(?:BIS)?$'
  );
  ALTER TABLE Deposit ADD CONSTRAINT Deposit_fk FOREIGN KEY (ZipCode, Country) REFERENCES Area(ZipCode, Country);
  ALTER TABLE deposit ADD CONSTRAINT onlyOneDepositPerAddress UNIQUE(AddressNo, Street, ZipCode, Country);
\end{lstlisting}

\begin{lstlisting}
  CREATE TABLE Transport (
    TransportID Serial NOT NULL,
    OccupiedSpace real NOT NULL,
    MaxCapacity real NOT NULL,
    IsAvailable boolean, 
    TransportType TransportType NOT NULL,
    DepositID integer NOT NULL
  );
  ALTER TABLE Transport ADD CONSTRAINT Transport_pk PRIMARY KEY(TransportID);
  ALTER TABLE Transport ADD CONSTRAINT Transport_fk FOREIGN KEY(DepositID) REFERENCES Deposit(DepositID);
  ALTER TABLE Transport ADD CONSTRAINT formatTransportMaxCapacity CHECK (
    MaxCapacity >0
  );
  ALTER TABLE Transport ADD CONSTRAINT formatTransportOccupiedSpace CHECK (
    OccupiedSpace >=0
  );
  ALTER TABLE Transport ADD CONSTRAINT checkTransportFullness CHECK(
    OccupiedSpace <= MaxCapacity
  );
\end{lstlisting}

\begin{lstlisting}
  CREATE TABLE Operator (
  Email emailString NOT NULL,
  BusinessMail emailString NOT NULL
);
ALTER TABLE Operator ADD CONSTRAINT Operator_pk PRIMARY KEY (BusinessMail);
ALTER TABLE Operator ADD CONSTRAINT Operator_fk FOREIGN KEY (Email) REFERENCES Account(Email);
\end{lstlistng}

\begin{lstlisting}
  CREATE TABLE Shipment (
    ShipmentID Serial NOT NULL,
    ShippingDate date NOT NULL,
    HasArrived boolean,
    ShippedFrom integer NOT NULL,
    DirectedTo integer,
    BusinessMail emailString NOT NULL,
    TransportID integer NOT NULL
  );
  ALTER TABLE Shipment ADD CONSTRAINT Shipment_pk PRIMARY KEY (ShipmentID);
  ALTER TABLE Shipment ADD CONSTRAINT Shipment_fk_startDeposit FOREIGN KEY (ShippedFrom) REFERENCES Deposit(DepositID);
  ALTER TABLE Shipment ADD CONSTRAINT Shipment_fk_arrivalDeposit FOREIGN KEY (DirectedTo) REFERENCES Deposit(DepositID);
  ALTER TABLE Shipment ADD CONSTRAINT checkDifferentStartEndDeposits CHECK (
    ShippedFrom <> DirectedTo
  );
  ALTER TABLE Shipment ADD CONSTRAINT Shipment_fk_transport FOREIGN KEY (TransportID) REFERENCES Transport(TransportID);
  ALTER TABLE Shipment ADD CONSTRAINT Shipment_fk_operator FOREIGN KEY (BusinessMail) REFERENCES Operator(Businessmail);
\end{lstlisting}

\begin{lstlisting}
  CREATE TABLE Ships ( 
    ShipmentID integer NOT NULL,
    OrderID integer NOT NULL
  );
  ALTER TABLE Ships ADD CONSTRAINT noDuplicateOrderInShipment UNIQUE (ShipmentID, OrderID);
  ALTER TABLE Ships ADD CONSTRAINT Ships_fk_Shipment FOREIGN KEY (ShipmentID) REFERENCES Shipment(ShipmentID);
  ALTER TABLE Ships ADD CONSTRAINT Ships_fk_Order FOREIGN KEY (OrderID) REFERENCES "Order"(OrderID);
\end{lstlisting}

\begin{lstlisting}
  CREATE TABLE Covers (
    TransportID integer NOT NULL,
    ZipCode numericString NOT NULL,
    Country letterString NOT NULL,
    Date date
  );
  ALTER TABLE Covers ADD CONSTRAINT Covers_fk_Tranport FOREIGN KEY (TransportID) REFERENCES Transport(TransportID);
  ALTER TABLE Covers ADD CONSTRAINT Covers_fk_Area FOREIGN KEY (ZipCode, Country) REFERENCES Area(ZipCode, Country);
  ALTER TABLE Covers ADD CONSTRAINT onlyOneAreaPerDay UNIQUE (TransportID, Date);
\end{lstlisting}

\begin{lstlisting}
  CREATE TABLE Driver (
    BusinessMail emailString NOT NULL,
    DrivingLicenceType DrivingLicenceType NOT NULL,
    IsAvailable boolean,
    Email emailString, 
    DepositID integer NOT NULL 
  );
  ALTER TABLE Driver ADD CONSTRAINT Driver_pk PRIMARY KEY (BusinessMail);
  ALTER TABLE Driver ADD CONSTRAINT Driver_fk_Account FOREIGN KEY (Email) REFERENCES Account(Email);
  ALTER TABLE Driver ADD CONSTRAINT Driver_fk_Deposit FOREIGN KEY (DepositID) REFERENCES Deposit(DepositID);
\end{lstlisting}

\begin{lstlisting}
  CREATE TABLE Drives(
    TransportID integer NOT NULL,
    BusinessMail emailString NOT NULL,
    Date date NOT NULL
  );
  ALTER TABLE Drives ADD CONSTRAINT Drives_fk_Driver FOREIGN KEY (BusinessMail) REFERENCES Driver(BusinessMail);
  ALTER TABLE Drives ADD CONSTRAINT Drives_fk_Transport FOREIGN KEY (TransportID) REFERENCES Transport(TransportID);
  ALTER TABLE Drives ADD CONSTRAINT onlyOneTravelPerDayTransport UNIQUE (TransportID, Date);
  ALTER TABLE Drives ADD CONSTRAINT onlyOneTravelPerDayDriver UNIQUE (BusinessMail, Date);
\end{lstlisting}

\begin{lstlisting}
  CREATE TABLE Stores(
    Name text NOT NULL,
    Supplier text NOT NULL,
    DepositID integer NOT NULL,
    Quantity integer NOT NULL
  );
  ALTER TABLE Stores ADD CONSTRAINT noDuplicateProductInDeposit UNIQUE (Name, Supplier, DepositID);
  ALTER TABLE Stores
  ADD CONSTRAINT Stores_fk_Product FOREIGN KEY (Name, Supplier) REFERENCES Product(Name, Supplier);
  ALTER TABLE Stores
  ADD CONSTRAINT Stores_fk_Deposit FOREIGN KEY (DepositID) REFERENCES Deposit(DepositID);
  ALTER TABLE Stores
  ADD CONSTRAINT formatStoresQuantity CHECK(Quantity > 0);
\end{lstlisting}
